<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <title>Estacionamento - Mobile</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <style>
    * {
      box-sizing: border-box;
    }

    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      text-align: center;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      margin: 0;
      padding: 20px;
      min-height: 100vh;
    }

    .container {
      max-width: 500px;
      margin: 0 auto;
      background: white;
      border-radius: 20px;
      padding: 30px 20px;
      box-shadow: 0 10px 40px rgba(0,0,0,0.3);
    }

    h1 {
      font-size: 28px;
      color: #333;
      margin: 0 0 10px 0;
    }

    .status-badge {
      display: inline-block;
      padding: 5px 15px;
      border-radius: 20px;
      font-size: 12px;
      font-weight: bold;
      margin-bottom: 20px;
    }

    .status-badge.online {
      background: #4CAF50;
      color: white;
    }

    .status-badge.offline {
      background: #999;
      color: white;
    }

    #total {
      font-size: 20px;
      margin-bottom: 25px;
      font-weight: bold;
      color: #555;
      padding: 15px;
      background: #f5f5f5;
      border-radius: 10px;
      display: inline-block;
      min-width: 200px;
    }

    .total-number {
      font-size: 32px;
      color: #667eea;
      display: block;
    }

    .vagas-container {
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 15px;
    }

    .vaga {
      font-size: 18px;
      padding: 25px 20px;
      border-radius: 15px;
      width: 100%;
      color: white;
      font-weight: bold;
      box-shadow: 0 4px 15px rgba(0,0,0,0.15);
      transition: all 0.3s ease;
      position: relative;
      overflow: hidden;
    }

    .vaga::before {
      content: '';
      position: absolute;
      top: 0;
      left: -100%;
      width: 100%;
      height: 100%;
      background: rgba(255,255,255,0.2);
      transition: left 0.5s;
    }

    .vaga:hover::before {
      left: 100%;
    }

    .vaga.livre { 
      background: linear-gradient(135deg, #4CAF50 0%, #45a049 100%);
    }
    
    .vaga.ocupada { 
      background: linear-gradient(135deg, #F44336 0%, #d32f2f 100%);
    }
    
    .vaga.bloqueada { 
      background: linear-gradient(135deg, #FFC107 0%, #ffa000 100%);
      color: #333;
    }

    .vaga-icon {
      font-size: 32px;
      margin-bottom: 8px;
      display: block;
    }

    .vaga-label {
      display: block;
      font-size: 14px;
      opacity: 0.9;
      margin-bottom: 5px;
    }

    .ultima-atualizacao {
      margin-top: 20px;
      font-size: 12px;
      color: #999;
    }

    .info-extra {
      margin-top: 20px;
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 10px;
    }

    .info-card {
      background: #f9f9f9;
      padding: 15px;
      border-radius: 10px;
      box-shadow: 0 2px 5px rgba(0,0,0,0.05);
    }

    .info-card-title {
      font-size: 12px;
      color: #999;
      margin-bottom: 5px;
    }

    .info-card-value {
      font-size: 24px;
      font-weight: bold;
      color: #667eea;
    }

    .historico {
      margin-top: 20px;
      padding: 15px;
      background: #f9f9f9;
      border-radius: 10px;
      text-align: left;
    }

    .historico-title {
      font-size: 14px;
      font-weight: bold;
      color: #333;
      margin-bottom: 10px;
    }

    .historico-item {
      font-size: 12px;
      padding: 8px;
      background: white;
      margin-bottom: 5px;
      border-radius: 5px;
      border-left: 3px solid #667eea;
    }

    .tempo-medio {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      padding: 15px;
      border-radius: 10px;
      margin-top: 15px;
    }

    .tempo-medio-label {
      font-size: 12px;
      opacity: 0.9;
    }

    .tempo-medio-valor {
      font-size: 28px;
      font-weight: bold;
      margin: 5px 0;
    }

    @media (min-width: 500px){
      .vagas-container {
        flex-direction: row;
        justify-content: center;
        flex-wrap: wrap;
      }
      .vaga {
        width: 48%;
      }
    }

    @keyframes pulse {
      0%, 100% { opacity: 1; }
      50% { opacity: 0.6; }
    }

    .loading {
      animation: pulse 1.5s infinite;
    }
  </style>
</head>
<body>
  <div class="container">
    <h1>üÖøÔ∏è Estacionamento</h1>
    <div id="status-badge" class="status-badge offline">Conectando...</div>
    
    <div id="total">
      <div style="font-size:14px; color:#999; margin-bottom:5px;">Vagas Dispon√≠veis</div>
      <span class="total-number">0</span>
      <div style="font-size:12px; color:#999; margin-top:5px;">de <span id="total-vagas">0</span> vagas</div>
    </div>

    <div id="vagas-container" class="vagas-container">
      <!-- Vagas ser√£o criadas dinamicamente -->
    </div>

    <div class="info-extra">
      <div class="info-card">
        <div class="info-card-title">Total de Acessos</div>
        <div class="info-card-value" id="total-acessos">0</div>
      </div>
      <div class="info-card">
        <div class="info-card-title">Taxa de Ocupa√ß√£o</div>
        <div class="info-card-value" id="taxa-ocupacao">0%</div>
      </div>
    </div>

    <div class="tempo-medio">
      <div class="tempo-medio-label">‚è±Ô∏è Tempo M√©dio de Perman√™ncia</div>
      <div class="tempo-medio-valor" id="tempo-medio">--</div>
      <div class="tempo-medio-label">Estimativa baseada no hist√≥rico</div>
    </div>

    <div class="historico">
      <div class="historico-title">üìä √öltimas Mudan√ßas</div>
      <div id="historico-lista">
        <div style="text-align:center; color:#999; font-size:12px; padding:20px;">
          Aguardando atividades...
        </div>
      </div>
    </div>

    <div id="ultima-atualizacao" class="ultima-atualizacao">Aguardando dados...</div>
  </div>

  <script src="https://unpkg.com/mqtt/dist/mqtt.min.js"></script>
  <script>
    // ===== CONFIGURA√á√ÉO =====
    const NUM_VAGAS = 2; // ALTERE AQUI para adicionar mais vagas (ex: 3, 4, 5...)
    
    const totalDiv = document.getElementById('total');
    const statusBadge = document.getElementById('status-badge');
    const ultimaAtualizacao = document.getElementById('ultima-atualizacao');
    const vagasContainer = document.getElementById('vagas-container');

    // Estruturas din√¢micas
    let vagas = {}; // {1: {estado: 'livre', livre: 1, timestamp: null, div: element}}
    let totalAcessos = 0;
    let historico = [];
    let temposOcupacao = [];

    // Criar vagas dinamicamente
    document.getElementById('total-vagas').textContent = NUM_VAGAS;
    for(let i = 1; i <= NUM_VAGAS; i++) {
      const vagaDiv = document.createElement('div');
      vagaDiv.id = `vaga${i}`;
      vagaDiv.className = 'vaga ocupada loading';
      vagaDiv.innerHTML = `
        <span class="vaga-icon">üöó</span>
        <span class="vaga-label">Vaga ${i}</span>
        <span>Carregando...</span>
      `;
      vagasContainer.appendChild(vagaDiv);
      
      vagas[i] = {
        estado: 'ocupada',
        livre: 0,
        timestamp: null,
        div: vagaDiv
      };
    }

    // Configura√ß√£o HiveMQ Cloud
    const client = mqtt.connect('wss://3c16c837ea4f4ac0966899396b41ab08.s1.eu.hivemq.cloud:8884/mqtt', {
      username: 'guilherme',
      password: 'Guilherme123',
      protocol: 'wss'
    });

    client.on('connect', () => {
      console.log('‚úÖ Conectado ao MQTT');
      client.subscribe('vaga/topico');
      client.subscribe('estacionamento/acessos');
      statusBadge.textContent = 'Online';
      statusBadge.classList.remove('offline');
      statusBadge.classList.add('online');
    });

    client.on('error', () => {
      statusBadge.textContent = 'Offline';
      statusBadge.classList.remove('online');
      statusBadge.classList.add('offline');
    });

    client.on('close', () => {
      statusBadge.textContent = 'Desconectado';
      statusBadge.classList.remove('online');
      statusBadge.classList.add('offline');
    });

    function atualizarHora() {
      const agora = new Date();
      const hora = agora.toLocaleTimeString('pt-BR');
      ultimaAtualizacao.textContent = `√öltima atualiza√ß√£o: ${hora}`;
    }

    function atualizarTotal() {
      const livres = Object.values(vagas).reduce((sum, v) => sum + v.livre, 0);
      totalDiv.innerHTML = `
        <div style="font-size:14px; color:#999; margin-bottom:5px;">Vagas Dispon√≠veis</div>
        <span class="total-number">${livres}</span>
        <div style="font-size:12px; color:#999; margin-top:5px;">de ${NUM_VAGAS} vagas</div>
      `;
    }

    function getIcone(estado) {
      if(estado === 'livre') return '‚úÖ';
      if(estado === 'ocupada') return 'üöó';
      if(estado === 'bloqueada') return 'üö´';
      return '‚ùì';
    }

    function getTexto(estado) {
      if(estado === 'livre') return 'Livre';
      if(estado === 'ocupada') return 'Ocupada';
      if(estado === 'bloqueada') return 'Bloqueada';
      return 'Desconhecido';
    }

    function adicionarHistorico(mensagem) {
      const agora = new Date();
      const hora = agora.toLocaleTimeString('pt-BR', {hour: '2-digit', minute: '2-digit'});
      historico.unshift({mensagem, hora, timestamp: agora});
      
      // Manter apenas √∫ltimos 5
      if(historico.length > 5) historico.pop();
      
      const lista = document.getElementById('historico-lista');
      lista.innerHTML = historico.map(h => 
        `<div class="historico-item">
          <span style="color:#667eea; font-weight:bold;">${h.hora}</span> - ${h.mensagem}
        </div>`
      ).join('');
    }

    function formatarTempo(ms) {
      const segundos = Math.floor(ms / 1000);
      const minutos = Math.floor(segundos / 60);
      const horas = Math.floor(minutos / 60);
      
      if(segundos < 60) return `${segundos}s`;
      if(minutos < 60) return `${minutos}min ${segundos % 60}s`;
      return `${horas}h ${minutos % 60}min`;
    }

    function calcularTempoMedio() {
      if(temposOcupacao.length === 0) return '--';
      const media = temposOcupacao.reduce((a, b) => a + b, 0) / temposOcupacao.length;
      return formatarTempo(media);
    }

    function atualizarTaxaOcupacao() {
      const livres = Object.values(vagas).reduce((sum, v) => sum + v.livre, 0);
      const ocupadas = NUM_VAGAS - livres;
      const taxa = Math.round((ocupadas / NUM_VAGAS) * 100);
      document.getElementById('taxa-ocupacao').textContent = taxa + '%';
    }

    function atualizarVaga(div, numero, estado) {
      div.classList.remove('livre', 'ocupada', 'bloqueada', 'loading');
      div.classList.add(estado);
      
      const icone = getIcone(estado);
      const texto = getTexto(estado);
      
      div.innerHTML = `
        <span class="vaga-icon">${icone}</span>
        <span class="vaga-label">Vaga ${numero}</span>
        <span>${texto}</span>
      `;
      
      adicionarHistorico(`Vaga ${numero} ficou ${texto.toLowerCase()}`);
      atualizarHora();
    }

    client.on('message', (topic, message) => {
      const status = message.toString();

      if(topic === 'estacionamento/acessos') {
        totalAcessos = parseInt(status);
        document.getElementById('total-acessos').textContent = totalAcessos;
        adicionarHistorico(`üöó Novo acesso registrado (#${totalAcessos})`);
        return;
      }

      // Detectar mensagens de vagas (vaga1:livre, vaga2:ocupada, etc)
      const match = status.match(/^vaga(\d+):(.+)$/);
      if(match) {
        const numVaga = parseInt(match[1]);
        const novoEstado = match[2];
        
        // Verificar se a vaga existe
        if(!vagas[numVaga]) {
          console.warn(`Vaga ${numVaga} n√£o existe. Configure NUM_VAGAS para ${numVaga} ou mais.`);
          return;
        }
        
        const vaga = vagas[numVaga];
        const estadoAnterior = vaga.estado;
        vaga.estado = novoEstado;
        vaga.livre = (novoEstado === "livre" && novoEstado !== "bloqueada") ? 1 : 0;
        
        // Calcular tempo REAL de ocupa√ß√£o
        if(novoEstado === 'ocupada' && estadoAnterior !== 'ocupada') {
          // Marca quando ficou ocupada
          vaga.timestamp = Date.now();
        } else if(estadoAnterior === 'ocupada' && novoEstado === 'livre') {
          // Calcula quanto tempo ficou ocupada
          if(vaga.timestamp) {
            const tempoReal = Date.now() - vaga.timestamp;
            temposOcupacao.push(tempoReal);
            if(temposOcupacao.length > 10) temposOcupacao.shift();
            document.getElementById('tempo-medio').textContent = calcularTempoMedio();
            console.log(`Vaga ${numVaga} ficou ocupada por: ${formatarTempo(tempoReal)}`);
            vaga.timestamp = null;
          }
        }
        
        atualizarVaga(vaga.div, numVaga, novoEstado);
        atualizarTotal();
        atualizarTaxaOcupacao();
      }
    });

    // Atualizar hora a cada segundo
    setInterval(atualizarHora, 1000);
  </script>
</body>
</html>
