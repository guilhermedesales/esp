<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <title>Estacionamento - Mobile</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <style>
    * {
      box-sizing: border-box;
    }

    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      text-align: center;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      margin: 0;
      padding: 20px;
      min-height: 100vh;
      transition: background 0.3s ease;
    }
    
    body.dark-mode {
      background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%);
    }

    .container {
      max-width: 500px;
      margin: 0 auto;
      background: white;
      border-radius: 20px;
      padding: 30px 20px;
      box-shadow: 0 10px 40px rgba(0,0,0,0.3);
      transition: background 0.3s ease, color 0.3s ease;
    }
    
    body.dark-mode .container {
      background: #0f3460;
      color: #e0e0e0;
    }

    h1 {
      font-size: 28px;
      color: #333;
      margin: 0 0 10px 0;
      transition: color 0.3s ease;
    }
    
    body.dark-mode h1 {
      color: #e0e0e0;
    }
    
    .theme-toggle {
      position: absolute;
      top: 20px;
      right: 20px;
      background: rgba(255,255,255,0.2);
      border: none;
      border-radius: 50%;
      width: 50px;
      height: 50px;
      font-size: 24px;
      cursor: pointer;
      transition: all 0.3s ease;
      backdrop-filter: blur(10px);
      box-shadow: 0 4px 15px rgba(0,0,0,0.2);
    }
    
    .theme-toggle:hover {
      transform: scale(1.1);
      background: rgba(255,255,255,0.3);
    }
    
    .theme-toggle:active {
      transform: scale(0.95);
    }

    .status-badge {
      display: inline-block;
      padding: 6px 16px;
      border-radius: 20px;
      font-size: 11px;
      font-weight: bold;
      margin-bottom: 15px;
      letter-spacing: 0.5px;
      text-transform: uppercase;
    }

    .status-badge.online {
      background: #4CAF50;
      color: white;
      animation: fadeIn 0.5s;
    }

    .status-badge.offline {
      background: #999;
      color: white;
    }
    
    @keyframes fadeIn {
      from { opacity: 0; transform: scale(0.9); }
      to { opacity: 1; transform: scale(1); }
    }

    #total {
      font-size: 20px;
      margin-bottom: 30px;
      font-weight: bold;
      color: #333;
      padding: 25px 20px;
      background: linear-gradient(135deg, #f5f5f5 0%, #e0e0e0 100%);
      border-radius: 15px;
      display: inline-block;
      min-width: 250px;
      box-shadow: 0 4px 15px rgba(0,0,0,0.1);
      transition: all 0.3s ease;
    }
    
    body.dark-mode #total {
      background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%);
      color: #e0e0e0;
    }

    .total-number {
      font-size: 48px;
      color: #4CAF50;
      display: block;
      text-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }
    
    .total-number.nenhuma {
      color: #F44336;
    }

    .vagas-container {
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 15px;
    }

    .vaga {
      font-size: 20px;
      padding: 30px 20px;
      border-radius: 15px;
      width: 100%;
      color: white;
      font-weight: bold;
      box-shadow: 0 6px 20px rgba(0,0,0,0.15);
      transition: all 0.3s ease;
      position: relative;
      overflow: hidden;
      transform: scale(1);
    }
    
    .vaga.livre {
      animation: pulseGreen 2s infinite;
    }
    
    @keyframes pulseGreen {
      0%, 100% { box-shadow: 0 6px 20px rgba(76, 175, 80, 0.3); }
      50% { box-shadow: 0 6px 30px rgba(76, 175, 80, 0.5); }
    }

    .vaga::before {
      content: '';
      position: absolute;
      top: 0;
      left: -100%;
      width: 100%;
      height: 100%;
      background: rgba(255,255,255,0.2);
      transition: left 0.5s;
    }

    .vaga:hover::before {
      left: 100%;
    }

    .vaga.livre { 
      background: linear-gradient(135deg, #4CAF50 0%, #45a049 100%);
    }
    
    .vaga.ocupada { 
      background: linear-gradient(135deg, #F44336 0%, #d32f2f 100%);
    }
    
    .vaga.bloqueada { 
      background: linear-gradient(135deg, #FFC107 0%, #ffa000 100%);
      color: #333;
    }

    .vaga-icon {
      font-size: 48px;
      margin-bottom: 10px;
      display: block;
    }

    .vaga-label {
      display: block;
      font-size: 16px;
      opacity: 0.95;
      margin-bottom: 8px;
      font-weight: 600;
    }
    
    .vaga-estado {
      font-size: 18px;
      font-weight: bold;
      text-transform: uppercase;
      letter-spacing: 1px;
    }

    .ultima-atualizacao {
      margin-top: 25px;
      font-size: 11px;
      color: #999;
      opacity: 0.8;
    }
    
    body.dark-mode #alerta-lotado {
      background: #533c1e !important;
      border-left-color: #ffa000 !important;
    }
    
    body.dark-mode .info-section {
      background: #16213e !important;
    }
    
    body.dark-mode .info-card {
      background: #0f3460 !important;
      color: #e0e0e0 !important;
    }
    
    body.dark-mode .info-label {
      color: #999 !important;
    }

    @media (min-width: 500px){
      .vagas-container {
        flex-direction: row;
        justify-content: center;
        flex-wrap: wrap;
      }
      .vaga {
        width: 48%;
      }
    }
  </style>
</head>
<body>
  <button class="theme-toggle" id="theme-toggle" title="Alternar tema">üåô</button>
  
  <div class="container">
    <div id="status-badge" class="status-badge offline">Conectando...</div>
    
    <h1>üÖøÔ∏è Estacionamento</h1>
    
    <div id="total">
      <div style="font-size:16px; color:#666; margin-bottom:10px; text-transform:uppercase; letter-spacing:1px;">Vagas Livres</div>
      <span class="total-number">0</span>
      <div style="font-size:14px; color:#999; margin-top:8px;">de <span id="total-vagas">0</span> dispon√≠veis</div>
    </div>

    <div id="vagas-container" class="vagas-container">
      <!-- Vagas ser√£o criadas dinamicamente -->
    </div>

    <!-- Alerta quando lotado -->
    <div id="alerta-lotado" style="display:none; margin-top:20px; padding:15px; background:#fff3cd; border-left:4px solid #ffc107; border-radius:8px; text-align:left; transition:all 0.3s ease;">
      <div style="font-size:14px; color:#856404; font-weight:bold; margin-bottom:5px;">‚ö†Ô∏è Estacionamento Lotado</div>
      <div style="font-size:12px; color:#856404;" id="tempo-espera">Tempo m√©dio de espera: calculando...</div>
    </div>

    <!-- Informa√ß√µes Pr√°ticas -->
    <div class="info-section" style="margin-top:25px; padding:20px; background:#f8f9fa; border-radius:12px; text-align:left; transition:all 0.3s ease;">
      <div style="font-size:14px; font-weight:bold; color:#333; margin-bottom:12px; text-align:center;">‚ÑπÔ∏è Informa√ß√µes</div>
      
      <div style="display:grid; grid-template-columns:1fr 1fr; gap:12px; font-size:13px;">
        <div class="info-card" style="padding:10px; background:white; border-radius:8px; box-shadow:0 2px 5px rgba(0,0,0,0.05); transition:all 0.3s ease;">
          <div class="info-label" style="color:#999; font-size:11px; margin-bottom:3px;">üí∞ Valor</div>
          <div style="color:#333; font-weight:600;">R$ 5,00/hora</div>
        </div>
        
        <div class="info-card" style="padding:10px; background:white; border-radius:8px; box-shadow:0 2px 5px rgba(0,0,0,0.05); transition:all 0.3s ease;">
          <div class="info-label" style="color:#999; font-size:11px; margin-bottom:3px;">üïê Hor√°rio</div>
          <div style="color:#333; font-weight:600;">24h</div>
        </div>
      </div>
      
      <div class="info-card" style="margin-top:10px; padding:10px; background:white; border-radius:8px; box-shadow:0 2px 5px rgba(0,0,0,0.05); text-align:center; transition:all 0.3s ease;">
        <div class="info-label" style="color:#999; font-size:11px; margin-bottom:3px;">‚è±Ô∏è Tempo M√©dio de Perman√™ncia</div>
        <div style="color:#667eea; font-weight:600; font-size:16px;" id="tempo-medio-user">--</div>
      </div>
    </div>

    <div id="ultima-atualizacao" class="ultima-atualizacao">Aguardando dados...</div>
  </div>

  <script src="https://unpkg.com/mqtt/dist/mqtt.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script>
    // ===== CONFIGURA√á√ÉO =====
    const NUM_VAGAS = 2; // ALTERE AQUI para adicionar mais vagas (ex: 3, 4, 5...)
    
    const SUPABASE_URL = 'https://nyqvxezfiibojfdarsqn.supabase.co';
    const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im55cXZ4ZXpmaWlib2pmZGFyc3FuIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjQ1MTczOTQsImV4cCI6MjA4MDA5MzM5NH0.nYVYqH1FuSsGQ2j6RMXT-mlG_th-nKWoV02TDiFOSTo';
    
    const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);
    
    const totalDiv = document.getElementById('total');
    const statusBadge = document.getElementById('status-badge');
    const ultimaAtualizacao = document.getElementById('ultima-atualizacao');
    const vagasContainer = document.getElementById('vagas-container');

    // Estruturas din√¢micas
    let vagas = {}; // {1: {estado: 'livre', livre: 1, timestamp: null, div: element}}
    let temposOcupacao = []; // Armazena √∫ltimas 30 dura√ß√µes

    // Criar vagas dinamicamente
    document.getElementById('total-vagas').textContent = NUM_VAGAS;
    for(let i = 1; i <= NUM_VAGAS; i++) {
      const vagaDiv = document.createElement('div');
      vagaDiv.id = `vaga${i}`;
      vagaDiv.className = 'vaga livre';
      vagaDiv.innerHTML = `
        <span class="vaga-icon">‚úÖ</span>
        <span class="vaga-label">Vaga ${i}</span>
        <span>Livre</span>
      `;
      vagasContainer.appendChild(vagaDiv);
      
      vagas[i] = {
        estado: 'livre',
        livre: 1,
        timestamp: null,
        div: vagaDiv
      };
    }
    
    // Atualizar contador inicial
    atualizarTotal();

    // Configura√ß√£o HiveMQ Cloud
    const client = mqtt.connect('wss://3c16c837ea4f4ac0966899396b41ab08.s1.eu.hivemq.cloud:8884/mqtt', {
      username: 'guilherme',
      password: 'Guilherme123',
      protocol: 'wss'
    });

    client.on('connect', () => {
      console.log('‚úÖ Conectado ao MQTT');
      client.subscribe('vaga/topico');
      statusBadge.textContent = '‚óè Sistema Online';
      statusBadge.classList.remove('offline');
      statusBadge.classList.add('online');
      
      // Carregar estado inicial das vagas
      carregarEstadoInicial();
    });

    client.on('error', () => {
      statusBadge.textContent = 'Offline';
      statusBadge.classList.remove('online');
      statusBadge.classList.add('offline');
    });

    client.on('close', () => {
      statusBadge.textContent = 'Desconectado';
      statusBadge.classList.remove('online');
      statusBadge.classList.add('offline');
    });

    function atualizarHora() {
      const agora = new Date();
      const hora = agora.toLocaleTimeString('pt-BR');
      ultimaAtualizacao.textContent = `√öltima atualiza√ß√£o: ${hora}`;
    }

    function atualizarTotal() {
      const livres = Object.values(vagas).reduce((sum, v) => sum + v.livre, 0);
      const classe = livres === 0 ? 'nenhuma' : '';
      totalDiv.innerHTML = `
        <div style="font-size:16px; color:#666; margin-bottom:10px; text-transform:uppercase; letter-spacing:1px;">Vagas Livres</div>
        <span class="total-number ${classe}">${livres}</span>
        <div style="font-size:14px; color:#999; margin-top:8px;">de ${NUM_VAGAS} dispon√≠veis</div>
      `;
      
      // Mostrar/esconder alerta de lotado
      const alertaLotado = document.getElementById('alerta-lotado');
      if(livres === 0) {
        alertaLotado.style.display = 'block';
        atualizarTempoEspera();
      } else {
        alertaLotado.style.display = 'none';
      }
    }
    
    function formatarTempo(ms) {
      const segundos = Math.floor(ms / 1000);
      const minutos = Math.floor(segundos / 60);
      const horas = Math.floor(minutos / 60);
      
      if(segundos < 60) return `${segundos}s`;
      if(minutos < 60) return `${minutos}min ${segundos % 60}s`;
      return `${horas}h ${minutos % 60}min`;
    }
    
    function calcularTempoMedio() {
      if(temposOcupacao.length === 0) return null;
      const media = temposOcupacao.reduce((a, b) => a + b, 0) / temposOcupacao.length;
      return media;
    }
    
    function atualizarTempoEspera() {
      const media = calcularTempoMedio();
      const tempoEsperaEl = document.getElementById('tempo-espera');
      
      if(media) {
        tempoEsperaEl.textContent = `Tempo m√©dio de espera: ${formatarTempo(media)}`;
      } else {
        tempoEsperaEl.textContent = 'Tempo m√©dio de espera: aguardando dados...';
      }
    }
    
    function atualizarTempoMedioDisplay() {
      const media = calcularTempoMedio();
      const displayEl = document.getElementById('tempo-medio-user');
      
      if(media) {
        displayEl.textContent = formatarTempo(media);
      } else {
        displayEl.textContent = '--';
      }
    }

    function getIcone(estado) {
      if(estado === 'livre') return '‚úÖ';
      if(estado === 'ocupada') return 'üöó';
      if(estado === 'bloqueada') return 'üö´';
      return '‚ùì';
    }

    function getTexto(estado) {
      if(estado === 'livre') return 'Livre';
      if(estado === 'ocupada') return 'Ocupada';
      if(estado === 'bloqueada') return 'Indispon√≠vel';
      return 'Carregando';
    }

    function atualizarVaga(div, numero, estado) {
      div.classList.remove('livre', 'ocupada', 'bloqueada', 'loading');
      div.classList.add(estado);
      
      const icone = getIcone(estado);
      const texto = getTexto(estado);
      
      div.innerHTML = `
        <span class="vaga-icon">${icone}</span>
        <span class="vaga-label">Vaga ${numero}</span>
        <span class="vaga-estado">${texto}</span>
      `;
      
      atualizarHora();
    }

    client.on('message', (topic, message) => {
      const status = message.toString();

      // Detectar mensagens de vagas (vaga1:livre, vaga2:ocupada, vaga1:bloqueada, etc)
      const match = status.match(/^vaga(\d+):(.+)$/);
      if(match) {
        const numVaga = parseInt(match[1]);
        const novoEstado = match[2];
        
        // Verificar se a vaga existe
        if(!vagas[numVaga]) {
          console.warn(`Vaga ${numVaga} n√£o existe. Configure NUM_VAGAS para ${numVaga} ou mais.`);
          return;
        }
        
        const vaga = vagas[numVaga];
        const estadoAnterior = vaga.estado;
        vaga.estado = novoEstado;
        // Vaga s√≥ conta como livre se n√£o estiver bloqueada
        vaga.livre = (novoEstado === "livre") ? 1 : 0;
        
        // Rastrear tempo de ocupa√ß√£o
        if(novoEstado === 'ocupada' && estadoAnterior !== 'ocupada') {
          vaga.timestamp = Date.now();
        } else if(estadoAnterior === 'ocupada' && novoEstado === 'livre') {
          if(vaga.timestamp) {
            const duracao = Date.now() - vaga.timestamp;
            // Ignorar ocupa√ß√µes muito curtas (< 5s) - provavelmente detec√ß√£o acidental
            if(duracao >= 5000) {
              temposOcupacao.push(duracao);
              if(temposOcupacao.length > 30) temposOcupacao.shift();
              atualizarTempoMedioDisplay();
            } else {
              console.log(`‚ö†Ô∏è Ocupa√ß√£o muito curta ignorada: ${Math.floor(duracao/1000)}s`);
            }
            vaga.timestamp = null;
          }
        }
        
        atualizarVaga(vaga.div, numVaga, novoEstado);
        atualizarTotal();
      }
    });

    // Carregar estado inicial das vagas do banco
    async function carregarEstadoInicial() {
      try {
        // Buscar √∫ltima mudan√ßa de cada vaga com timestamp
        for(let i = 1; i <= NUM_VAGAS; i++) {
          const { data, error } = await supabase
            .from('historico_vagas')
            .select('estado_novo, estado_anterior, timestamp')
            .eq('numero_vaga', i)
            .order('timestamp', { ascending: false })
            .limit(1);
          
          if(!error && data && data.length > 0) {
            const estado = data[0].estado_novo;
            const vaga = vagas[i];
            vaga.estado = estado;
            vaga.livre = (estado === 'livre') ? 1 : 0;
            
            // Se vaga j√° est√° ocupada, marcar timestamp do banco (n√£o do F5)
            if(estado === 'ocupada') {
              vaga.timestamp = new Date(data[0].timestamp).getTime();
            }
            
            atualizarVaga(vaga.div, i, estado);
            console.log(`‚úÖ Vaga ${i} carregada do banco: ${estado}`);
          } else {
            console.log(`üí° Vaga ${i} mantida como livre (sem dados no banco)`);
          }
        }
        
        atualizarTotal();
        
        // Carregar tempo m√©dio do banco
        await carregarTempoMedioDoBanco();
        
      } catch(e) {
        console.warn('‚ö†Ô∏è Erro ao carregar estado inicial:', e.message);
        console.log('üí° Sistema funcionar√° com estados padr√£o at√© receber MQTT');
      }
    }
    
    // Carregar tempo m√©dio de perman√™ncia do banco (√∫ltimas 30 ocupa√ß√µes)
    async function carregarTempoMedioDoBanco() {
      try {
        // Buscar hist√≥rico de mudan√ßas ordenado por tempo (√∫ltimas 200 para garantir)
        const { data, error } = await supabase
          .from('historico_vagas')
          .select('numero_vaga, estado_anterior, estado_novo, timestamp')
          .order('timestamp', { ascending: false })
          .limit(200);
        
        if(error || !data) {
          console.log('üí° N√£o h√° dados suficientes para calcular tempo m√©dio');
          return;
        }
        
        // Processar dados por vaga para encontrar pares ocupada->livre
        const ocupacoesCompletas = []; // {duracao, timestampFim}
        
        // Ordenar por tempo crescente para processar cronologicamente
        const historico = data.reverse();
        
        // Rastrear quando cada vaga ficou ocupada
        const timestampsOcupacao = {};
        
        for(const mudanca of historico) {
          const vagaNum = mudanca.numero_vaga;
          const timestamp = new Date(mudanca.timestamp).getTime();
          
          // Quando fica ocupada, marcar timestamp
          if(mudanca.estado_novo === 'ocupada' && mudanca.estado_anterior !== 'ocupada') {
            timestampsOcupacao[vagaNum] = timestamp;
          }
          // Quando libera, calcular dura√ß√£o e guardar com timestamp do fim
          else if(mudanca.estado_anterior === 'ocupada' && mudanca.estado_novo === 'livre') {
            if(timestampsOcupacao[vagaNum]) {
              const duracao = timestamp - timestampsOcupacao[vagaNum];
              // Ignorar ocupa√ß√µes muito curtas (< 5s) - provavelmente detec√ß√£o acidental
              if(duracao >= 5000) {
                ocupacoesCompletas.push({
                  duracao: duracao,
                  timestampFim: timestamp
                });
              }
              delete timestampsOcupacao[vagaNum];
            }
          }
        }
        
        // Ordenar por timestamp do fim (mais recente primeiro) e pegar √∫ltimas 30
        ocupacoesCompletas.sort((a, b) => b.timestampFim - a.timestampFim);
        const ultimas30 = ocupacoesCompletas.slice(0, 30).map(o => o.duracao);
        
        if(ultimas30.length > 0) {
          temposOcupacao = ultimas30;
          atualizarTempoMedioDisplay();
          console.log(`‚úÖ Tempo m√©dio carregado: ${ultimas30.length} ocupa√ß√µes encontradas (‚â•5s)`);
        } else {
          console.log('üí° Nenhuma ocupa√ß√£o completa encontrada no hist√≥rico');
        }
        
      } catch(e) {
        console.warn('‚ö†Ô∏è Erro ao calcular tempo m√©dio:', e.message);
      }
    }
    
    // Atualizar hora a cada segundo
    setInterval(atualizarHora, 1000);
    
    // === MODO NOTURNO ===
    const themeToggle = document.getElementById('theme-toggle');
    const body = document.body;
    
    // Carregar prefer√™ncia salva
    const savedTheme = localStorage.getItem('theme');
    if(savedTheme === 'dark') {
      body.classList.add('dark-mode');
      themeToggle.textContent = '‚òÄÔ∏è';
    }
    
    // Toggle ao clicar
    themeToggle.addEventListener('click', () => {
      body.classList.toggle('dark-mode');
      
      if(body.classList.contains('dark-mode')) {
        themeToggle.textContent = '‚òÄÔ∏è';
        localStorage.setItem('theme', 'dark');
      } else {
        themeToggle.textContent = 'üåô';
        localStorage.setItem('theme', 'light');
      }
    });
  </script>
</body>
</html>
